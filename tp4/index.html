
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Les Travaux Pratiques du cours eServices">
      
      
        <link rel="canonical" href="http://liliasfaxi.github.io/TP-eServices/tp4/">
      
      
        <meta name="author" content="Lilia Sfaxi">
      
      
        <link rel="shortcut icon" href="../img/favicon.ico">
      
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-1.7.1">
    
    
      
        <title>TP4 - TP eServices</title>
      
    
    
      <script src="../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-2421e7e627.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-8817cfa535.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    

    <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
    <link rel="stylesheet" href="../css/highlight.css">
    <link rel="stylesheet" href="../css/codehilite.css">
    <link rel="stylesheet" href="../css/tooltip.css">

    <link rel="stylesheet" href="../css/customizations.css">
    <link rel="stylesheet" href="../css/site-customizations.css">
  </head>
  
  
  
  
    <body data-md-color-primary="" data-md-color-accent="amber">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="http://liliasfaxi.github.io/TP-eServices/" title="TP eServices" class="md-logo md-header-nav__button">
            <img src="../img/logo.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            TP4
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/liliasfaxi/TP-eServices/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      liliasfaxi/TP-eServices
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../img/logo.png">
      </i>
    
    TP eServices
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/liliasfaxi/TP-eServices/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      liliasfaxi/TP-eServices
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Travaux Pratiques eServices" class="md-nav__link">
      Travaux Pratiques eServices
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp1/" title="TP1" class="md-nav__link">
      TP1
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp2/" title="TP2" class="md-nav__link">
      TP2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp3/" title="TP3" class="md-nav__link">
      TP3
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        TP4
      </label>
    
    <a href="./" title="TP4" class="md-nav__link md-nav__link--active">
      TP4
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#telecharger-pdf" title="Télécharger PDF" class="md-nav__link">
    Télécharger PDF
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectifs-du-tp" title="Objectifs du TP" class="md-nav__link">
    Objectifs du TP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgement" title="Acknowledgement" class="md-nav__link">
    Acknowledgement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outils-et-versions" title="Outils et Versions" class="md-nav__link">
    Outils et Versions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-microservices" title="Architecture Microservices" class="md-nav__link">
    Architecture Microservices
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#presentation" title="Présentation" class="md-nav__link">
    Présentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-proposee" title="Architecture Proposée" class="md-nav__link">
    Architecture Proposée
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation-des-microservices" title="Création des Microservices" class="md-nav__link">
    Création des Microservices
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#microservice-productservice" title="Microservice ProductService" class="md-nav__link">
    Microservice ProductService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plusieurs-instances-du-microservice-productservice" title="Plusieurs Instances du Microservice ProductService" class="md-nav__link">
    Plusieurs Instances du Microservice ProductService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microservice-configservice" title="Microservice ConfigService" class="md-nav__link">
    Microservice ConfigService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microservice-discoveryservice" title="Microservice DiscoveryService" class="md-nav__link">
    Microservice DiscoveryService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microservice-proxyservice" title="Microservice ProxyService" class="md-nav__link">
    Microservice ProxyService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#homework" title="Homework" class="md-nav__link">
    Homework
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp5/" title="TP5" class="md-nav__link">
      TP5
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#telecharger-pdf" title="Télécharger PDF" class="md-nav__link">
    Télécharger PDF
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectifs-du-tp" title="Objectifs du TP" class="md-nav__link">
    Objectifs du TP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgement" title="Acknowledgement" class="md-nav__link">
    Acknowledgement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outils-et-versions" title="Outils et Versions" class="md-nav__link">
    Outils et Versions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-microservices" title="Architecture Microservices" class="md-nav__link">
    Architecture Microservices
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#presentation" title="Présentation" class="md-nav__link">
    Présentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-proposee" title="Architecture Proposée" class="md-nav__link">
    Architecture Proposée
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation-des-microservices" title="Création des Microservices" class="md-nav__link">
    Création des Microservices
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#microservice-productservice" title="Microservice ProductService" class="md-nav__link">
    Microservice ProductService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plusieurs-instances-du-microservice-productservice" title="Plusieurs Instances du Microservice ProductService" class="md-nav__link">
    Plusieurs Instances du Microservice ProductService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microservice-configservice" title="Microservice ConfigService" class="md-nav__link">
    Microservice ConfigService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microservice-discoveryservice" title="Microservice DiscoveryService" class="md-nav__link">
    Microservice DiscoveryService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microservice-proxyservice" title="Microservice ProxyService" class="md-nav__link">
    Microservice ProxyService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#homework" title="Homework" class="md-nav__link">
    Homework
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/liliasfaxi/TP-eServices/edit/master/docs/tp4.md" title="Edit this page" class="md-icon md-content__icon">edit</a>
                
                
                <h1 id="tp4-microservices-avec-spring-boot-et-spring-cloud">TP4 - Microservices avec Spring Boot et Spring Cloud<a class="headerlink" href="#tp4-microservices-avec-spring-boot-et-spring-cloud" title="Permanent link">&para;</a></h1>
<p><img alt="Microservices" src="../img/microservices.png" /></p>
<h2 id="telecharger-pdf">Télécharger PDF<a class="headerlink" href="#telecharger-pdf" title="Permanent link">&para;</a></h2>
<p><a href="../tp4.pdf"><img alt="Download TP4" src="../img/pdf.png" /></a></p>
<h2 id="objectifs-du-tp">Objectifs du TP<a class="headerlink" href="#objectifs-du-tp" title="Permanent link">&para;</a></h2>
<ol>
<li>Création de microservices avec Spring Boot et Spring Cloud</li>
<li>Déploiement d'un microservices sur plusieurs instances</li>
</ol>
<h2 id="acknowledgement">Acknowledgement<a class="headerlink" href="#acknowledgement" title="Permanent link">&para;</a></h2>
<p>Ce TP a été largement inspiré du travail d'un binôme d'étudiants en Génie Logiciel à l'INSAT, promotion 2017 (Houssem Ben Braiek et Hadhemi Jabnoun), que je tiens à féliciter et remercier.</p>
<h2 id="outils-et-versions">Outils et Versions<a class="headerlink" href="#outils-et-versions" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://projects.spring.io/spring-boot/">Spring Boot</a> Version: 1.5.8</li>
<li><a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> Version 1.2.4</li>
<li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index-jsp-138363.html">Java</a> Version 1.8.0_121</li>
<li><a href="https://maven.apache.org/">Maven</a> Version 3.5.2</li>
<li><a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a> Version Ultimate 2016.1 (ou tout autre IDE de votre choix)</li>
</ul>
<h2 id="architecture-microservices">Architecture Microservices<a class="headerlink" href="#architecture-microservices" title="Permanent link">&para;</a></h2>
<h3 id="presentation">Présentation<a class="headerlink" href="#presentation" title="Permanent link">&para;</a></h3>
<p>Une architecture <a href="https://martinfowler.com/articles/microservices.html">Microservices</a> représente un moyen de concevoir les applications comme ensemble de services indépendamment déployables. Ces services doivent de préférence être organisés autours des compétences métier, de déploiement automatique, d'extrémités intelligentes et de contrôle décentralisé des technologies et des données.</p>
<h3 id="architecture-proposee">Architecture Proposée<a class="headerlink" href="#architecture-proposee" title="Permanent link">&para;</a></h3>
<p>L'objectif de ce travail est de montrer comment créer plusieurs services indépendamment déployables qui communiquent entre eux, en utilisant les facilités offertes par Spring Cloud et Spring Boot. <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> fournit des outils pour les développeurs pour construire rapidement et facilement des patrons communs de systèmes répartis (tel que des services de configuration, de découverte ou de routage intelligent). <a href="https://projects.spring.io/spring-boot/">Spring Boot</a> permet de son côté de construire des applications Spring rapidement aussi rapidement que possible, en minimisant au maximum le temps de configuration, d'habitude pénible, des applications Spring.</p>
<p>Nous allons donc créer les microservices suivants:</p>
<ol>
<li><em>Product Service</em> : Service principal, qui offre une API REST pour lister une liste de produits.</li>
<li><em>Config Service</em> : Service de configuration, dont le rôle est de centraliser les fichiers de configuration des différents microservices dans un endroit unique.</li>
<li><em>Proxy Service</em> : Passerelle se chargeant du routage d'une requête vers l'une des instances d'un service, de manière à gérer automatiquement la distribution de charge.</li>
<li><em>Discovery Service</em>: Service permettant l'enregistrement des instances de services en vue d'être découvertes par d'autres services.</li>
</ol>
<p>L'architecture résultante aura l'allure suivante:</p>
<p><center><img src="../img/tp4/archi.png"></center></p>
<h2 id="creation-des-microservices">Création des Microservices<a class="headerlink" href="#creation-des-microservices" title="Permanent link">&para;</a></h2>
<h3 id="microservice-productservice">Microservice <strong>ProductService</strong><a class="headerlink" href="#microservice-productservice" title="Permanent link">&para;</a></h3>
<p>Nous commençons par créer le service principal: <em>Product Service</em>.</p>
<p><center><img src="../img/tp4/archi-s1.png"></center></p>
<p>Chaque microservice sera sous forme d'un projet Spring. Pour créer rapidement et facilement un projet Spring avec toutes les dépendances nécessaires, Spring Boot fournit <em>Spring Initializr</em>.</p>
<p>Pour cela, aller au site <em><a href="http://start.spring.io">start.spring.io</a></em>, et créer un projet avec les caractéristiques suivantes:</p>
<ul>
<li>Projet Maven avec Java et Spring Boot version 1.5.8</li>
<li>Group: tn.insat.tpmicro</li>
<li>Artifact: product-service</li>
<li>Dépendances:<ul>
<li>Web</li>
<li>Rest Repositories</li>
<li>JPA : Java Persistence API</li>
<li>H2 : base de données pour le stockage</li>
<li>Actuator : pour le montoring et la gestion de l'application</li>
<li>Eureka Discovery : pour l'intégration avec le <em>Discovery Service</em></li>
<li>Config Client : pour l'intégration avec le <em>Config Service</em></li>
</ul>
</li>
</ul>
<p>Suivre ensuite les étapes suivantes pour créer le microservice <em>ProductService</em>:</p>
<ul>
<li>Ouvrir le projet téléchargé avec IntelliJ IDEA.</li>
<li>Sous le répertoire <em>src/main/java</em> et dans le package <em>tn.insat.tpmicro.productservice</em>, créer la classe <em>Product</em> suivante:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.productservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.GeneratedValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Product</span><span class="o">(){</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Product</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>Cette classe est annotée avec JPA, pour stocker ensuite les objets <em>Product</em> dans la base de données H2 grâce à Spring Data. Pour cela, créer l'interface <em>ProductRepository</em> dans le même package:</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.productservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Product</span> <span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>

<p>Pour insérer les objets dans la base, nous utiliserons l'objet <em>Stream</em>. Pour cela, nous allons créer la classe <em>DummyDataCLR</em> :</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.productservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.CommandLineRunner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">DummyDataCLR</span> <span class="kd">implements</span> <span class="n">CommandLineRunner</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">strings</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;Pencil&quot;</span><span class="o">,</span> <span class="s">&quot;Book&quot;</span><span class="o">,</span> <span class="s">&quot;Eraser&quot;</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">productRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Product</span><span class="o">(</span><span class="n">s</span><span class="o">)));</span>
        <span class="n">productRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ProductRepository</span> <span class="n">productRepository</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>

<p>Nous remarquons ici que le <em>productRepository</em> sera instancié automatiquement grâce au mécanisme d'injection de dépendances, utilisé par Spring.</p>
<p>Lancer la classe principale. Une base de données H2 sera créée et le <em>CommandLineRunner</em> se chargera de lui injecter les données.</p>
<div class="admonition warning">
<p class="admonition-title">Attention</p>
<p>Prenez soin d'utiliser JDK 8!</p>
</div>
<p>Pour exécuter votre application:</p>
<ul>
<li>Créer une configuration <em>mvn package</em> en faisant <em>Run-&gt;Edit Configurations</em> puis en créant une nouvelle configuration de type <em>Maven</em> avec la commande <em>package</em> comme suit:</li>
</ul>
<p><img alt="Configuration mvn package" src="../img/tp4/package.png" /></p>
<p>Un répertoire <em>target</em> sera créé, contenant les classes générées.</p>
<ul>
<li>Lancer ensuite la configuration Spring Boot <em>ProductServiceApplication</em> créée par défaut par IntelliJ. Le résultat sur la console devrait ressembler à ce qui suit:</li>
</ul>
<p><img alt="Configuration Spring Boot" src="../img/tp4/boot.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Pour éviter de lancer à chaque fois les deux configurations, ajouter dans la deuxième configuration une dépendance vers la première, rajouter cette dernière dans la case <em>Before Launch: Build, Maven Goal, Activate Tool Window</em>, comme suit:</p>
<p><img alt="Ajout dépendance" src="../img/tp4/dependanceConfig.png" /></p>
</div>
<p>Pour tester votre application, ouvrir la page <a href="http://localhost:8080">http://localhost:8080</a> sur le navigateur. Vous obtiendrez (si tout se passe bien) le résultat suivant:</p>
<p><img alt="Service REST" src="../img/tp4/rest1.png" /></p>
<p>Vous remarquerez que le service REST créé respecte automatiquement la norme <a href="https://spring.io/understanding/HATEOAS">HATEOAS</a>, qui offre dans les services REST, les liens pour naviguer dynamiquement entre les interfaces.</p>
<p>Si vous naviguez vers la page <a href="http://localhost:8080/products">http://localhost:8080/products</a>, vous verrez la liste des produits, injectés par le CLR, comme suit:</p>
<p><img alt="Liste Produits" src="../img/tp4/products.png" /></p>
<p>Pour voir les informations relatives à un seul produit, il suffit de connaître son ID: <a href="http://localhost:8080/products/1">http://localhost:8080/products/1</a>, par exemple.</p>
<p>Pour rajouter une fonctionnalité de recherche par nom, par exemple, modifier l'interface <em>ProductRepository</em>, comme suit:</p>
<p><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.productservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.query.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.rest.core.annotation.RepositoryRestResource</span><span class="o">;</span>

<span class="nd">@RepositoryRestResource</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Product</span> <span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;select p from Product p where p.name like :name&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">productByName</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">mc</span>
            <span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</pre></div><br />
Pour tester cette fonctionnalité de recherche, aller au lien <a href="http://localhost:8080/products/search/productByName?name=Eraser">http://localhost:8080/products/search/productByName?name=Eraser</a></p>
<p>Le résultat obtenu sera le suivant:</p>
<p><img alt="Résultat de la recherche par nom" src="../img/tp4/search.png" /></p>
<p>La dépendance <em>Actuator</em> qui a été rajoutée au projet permet d'afficher des informations sur votre API REST sans avoir à implémenter explicitement la fonctionnalité. Par exemple, si vous allez vers <a href="http://localhost:8080/metrics">http://localhost:8080/metrics</a>, vous pourrez avoir plusieurs informations sur le microservice, tel que le nombre de threads, la capacité mémoire, la classe chargée en mémoire, etc. Mais d'abord, rajouter les deux lignes suivantes au fichier <em>src/main/resources/application.properties</em> pour (1) afficher des informations plus détaillées sur l'état du service et (2) désactiver les contraintes de sécurité par défaut:</p>
<div class="codehilite"><pre><span></span><span class="na">  endpoints.health.sensitive</span> <span class="o">=</span> <span class="s">false</span>
<span class="na">  management.security.enabled</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>

<p>Relancer le projet. Le résultat obtenu en exécutant <a href="http://localhost:8080/metrics">http://localhost:8080/metrics</a> sera comme suit:</p>
<p><img alt="Metrics" src="../img/tp4/metrics.png" /></p>
<p>Les informations sur l'état du service sont affichées grâce à <a href="http://localhost:8080/health">http://localhost:8080/health</a></p>
<p><img alt="Health" src="../img/tp4/health.png" /></p>
<h3 id="plusieurs-instances-du-microservice-productservice">Plusieurs Instances du Microservice <strong>ProductService</strong><a class="headerlink" href="#plusieurs-instances-du-microservice-productservice" title="Permanent link">&para;</a></h3>
<p>Nous allons maintenant créer d'autres instances du même service et les déployer sur des ports différents.</p>
<p><center><img src="../img/tp4/archi-s2.png"></center></p>
<p>Pour lancer plusieurs instances du service <em>ProductService</em>, nous allons définir plusieurs configurations avec des numéros de port différents. Pour cela:</p>
<ul>
<li>Aller à <em>Run-&gt;Edit Configurations</em>, et copier la configuration <em>ProductServiceApplication</em> en la sélectionnant dans la barre latérale, et en cliquant sur l'icône <img alt="copy" src="../img/tp4/copy.png" />. Une nouvelle configuration sera créée.</li>
<li>Changer son nom: <em>ProductServiceApplication:8081</em></li>
<li>Ajouter dans la case <em>Program Arguments</em> l'argument suivant:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">--server.port</span><span class="o">=</span><span class="s">8081</span>
</pre></div>

<ul>
<li>Lancer la configuration. Un nouveau service sera disponible à l'adresse: <a href="http://localhost:8081">http://localhost:8081</a></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>En exécutant la seconde configuration, un popup s'affiche dans IntelliJ, qui vous demande si vous voulez afficher le dashboard pour visualiser plusieurs instances Spring Boot, comme suit:</p>
<p><img alt="Run dashboard" src="../img/tp4/run-dashboard.png" /></p>
<p>Cliquer dessus, et choisir : <em>Show Run Configurations in Dashboard</em>. La vue suivante s'affiche, en bas de votre écran:</p>
<p><img alt="Spring Boot Dashboard" src="../img/tp4/dashboard.png" /></p>
<p>Vous pouvez désormais gérer vos instances dans cette fenêtre.</p>
</div>
<ul>
<li>Refaire les mêmes étapes pour créer une instance du service tourant sur le port 8082.</li>
</ul>
<h3 id="microservice-configservice">Microservice <strong>ConfigService</strong><a class="headerlink" href="#microservice-configservice" title="Permanent link">&para;</a></h3>
<p>Dans une architecture microservices, plusieurs services s'exécutent en même temps, sur des processus différents, avec chacun sa propre configuration et ses propres paramètres. Spring Cloud Config fournit un support côté serveur et côté client pour externaliser les configurations dans un système distribué. Grâce au service de configuration, il est possible d'avoir un endroit centralisé pour gérer les propriétés de chacun de ces services.</p>
<p><center><img src="../img/tp4/archi-s3.png"></center></p>
<p>Pour cela:</p>
<ul>
<li>Commencer par créer un service ConfigService dans <em>Spring Initializr</em>, avec les dépendances appropriées, comme indiqué sur la figure suivante:</li>
</ul>
<p><img alt="Nouveau ConfigService" src="../img/tp4/configservice.png" /></p>
<ul>
<li>Ouvrir le projet dans une autre instance d'IntelliJ IDEA.</li>
<li>Pour exposer un service de configuration, utiliser l'annotation <em>@EnableConfigServer</em> pour la classe <em>ConfigServiceApplication</em>, comme suit:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.configservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.config.server.EnableConfigServer</span><span class="o">;</span>

<span class="nd">@EnableConfigServer</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ConfigServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<ul>
<li>Pour paramétrer ce service de configuration, ajouter dans son fichier <em>application.properties</em> les valeurs suivantes:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">  server.port</span><span class="o">=</span><span class="s">8888</span>
<span class="na">  spring.cloud.config.server.git.uri</span><span class="o">=</span><span class="s">file:./src/main/resources/myConfig</span>
</pre></div>

<p>Ceci indique que le service de configuration sera lancé sur le port 8888 et que le répertoire contenant les fichiers de configuration se trouve dans le répertoire <em>src/main/resources/myConfig</em>. Il suffit maintenant de créer ce répertoire.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Pour pouvoir référencer un répertoire avec son chemin absolu, utiliser plutôt <em>file:///&lt;chemin_absolu></em>.</p>
</div>
<ul>
<li>Créer le répertoire <em>myConfig</em> à l'arborescence <em>src/main/resources</em></li>
<li>Créer dans ce répertoire le fichier <em>application.properties</em> dans lequel vous insérez l'instruction suivante:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">global</span><span class="o">=</span><span class="s">xxxxx</span>
</pre></div>

<p>Ce fichier sera partagé entre tous les microservices utilisant ce service de configuration.</p>
<ul>
<li>Le répertoire de configuration doit être un répertoire git. Pour cela:<ul>
<li>Ouvrir le terminal avec IntelliJ et naviguer vers ce répertoire.</li>
<li>Initialiser votre répertoire: <code>git init</code></li>
<li>Créer une entrée racine dans le repository: <code>git add .</code></li>
<li>Faire un commit: <code>git commit -m &quot;add .&quot;</code></li>
</ul>
</li>
</ul>
<p>Revenir vers le projet <em>ProductService</em> et ajouter dans le fichier de configuration <em>application.properties</em>:</p>
<div class="codehilite"><pre><span></span><span class="na">spring.application.name</span> <span class="o">=</span> <span class="s">product-service</span>
<span class="na">spring.cloud.config.uri</span> <span class="o">=</span> <span class="s">http://localhost:8888</span>
</pre></div>

<p>Redémarrer vos services. Pour consulter le service de configuration, aller à <a href="http://localhost:8888/product-service/master">http://localhost:8888/product-service/master</a>.</p>
<p>Vous verrez le fichier JSON suivant:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;product-service&quot;</span><span class="p">,</span>
  <span class="nx">profiles</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;master&quot;</span>
  <span class="p">],</span>
  <span class="nx">label</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">version</span><span class="o">:</span> <span class="s2">&quot;6e1ea61d706133e2d8b62f40c6b784192fb58e8a&quot;</span><span class="p">,</span>
  <span class="nx">state</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">propertySources</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;file:./src/main/resources/myConfig/application.properties&quot;</span><span class="p">,</span>
      <span class="nx">source</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">global</span><span class="o">:</span> <span class="s2">&quot;xxxxx&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p>Comme le fichier <em>application.properties</em> contient toutes les propriétés partagées des différents microservices, nous aurons besoins d'autres fichiers pour les propriétés spécifiques à un microservice. Pour cela:</p>
<ul>
<li>Créer dans le répertoire <em>myConfig</em> un fichier <em>product-service.properties</em> pour le service <em>ProductService</em>.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Attention</p>
<p>Le nom du fichier doit correspondre à la propriété <em>spring.application.name</em> que vous avez saisi dans le fichier <em>application.properties</em> de votre microservices!</p>
</div>
<ul>
<li>Ajouter les propriétés de votre service, à savoir, par exemple:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">  me</span><span class="o">=</span><span class="s">lilia.sfaxi@insat.rnu.tn</span>
</pre></div>

<p>Relancer le microservice de configuration. En consultant l'url <a href="http://localhost:8888/product-service/master">http://localhost:8888/product-service/master</a>, nous remarquons l'ajout de la nouvelle propriété.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;product-service&quot;</span><span class="p">,</span>
  <span class="nx">profiles</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;master&quot;</span>
  <span class="p">],</span>
  <span class="nx">label</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">version</span><span class="o">:</span> <span class="s2">&quot;6e1ea61d706133e2d8b62f40c6b784192fb58e8a&quot;</span><span class="p">,</span>
  <span class="nx">state</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">propertySources</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;file:./src/main/resources/myConfig/product-service.properties&quot;</span><span class="p">,</span>
      <span class="nx">source</span><span class="o">:</span> <span class="p">{</span>
<span class="hll">        <span class="nx">me</span><span class="o">:</span> <span class="s2">&quot;lilia.sfaxi@insat.rnu.tn&quot;</span>
</span>      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;file:./src/main/resources/myConfig/application.properties&quot;</span><span class="p">,</span>
      <span class="nx">source</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">global</span><span class="o">:</span> <span class="s2">&quot;xxxxx&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<p>Nous allons maintenant définir un appel REST à cette propriété. Pour cela:</p>
<ul>
<li>Créer la classe <em>ProductRestService</em> dans le projet <em>product-service</em>. Son code ressemblera à ce qui suit:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.productservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductRestService</span> <span class="o">{</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${me}&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">me</span><span class="o">;</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/messages&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">tellMe</span><span class="o">(){</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;c&#39;est moi qui ait répondu!&quot;</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">me</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<ul>
<li>Redémarrer les trois instances du service, puis appeler dans votre navigateur le service en tapant: <a href="http://localhost:8080/messages">http://localhost:8080/messages</a>. Vous verrez le résultat suivant sur le navigateur:</li>
</ul>
<p><img alt="Service REST" src="../img/tp4/rest-service.png" /></p>
<ul>
<li>Consulter votre Spring Dashboard, vous verrez le message suivant dans la console de l'instance du service lancée sur le port 8080:</li>
</ul>
<p><img alt="Service REST" src="../img/tp4/rest-console.png" /></p>
<h3 id="microservice-discoveryservice">Microservice <strong>DiscoveryService</strong><a class="headerlink" href="#microservice-discoveryservice" title="Permanent link">&para;</a></h3>
<p>Pour éviter un couplage fort entre microservices, il est fortement recommandé d'utiliser un service de découverte qui permet d'enregistrer les propriétés des différents services et d'éviter ainsi d'avoir à appeler un service directement. Au lieu de cela, le service de découverte fournira dynamiquement les informations nécessaires, ce qui permet d'assurer l'élasticité et la dynamicité propres à une architecture microservices.</p>
<p><center><img src="../img/tp4/archi-s4.png"></center></p>
<p>Pour réaliser cela, Netflix offre le service <a href="https://spring.io/guides/gs/service-registration-and-discovery/">Eureka Service Registration and Discovery</a>, que nous allons utiliser dans notre application.</p>
<ul>
<li>Revenir à <em>Spring Initializr</em> et créer un nouveau projet Spring Boot intitulé <em>discovery-service</em> avec les dépendances <em>Eureka Server</em> et <em>Config Client</em>.</li>
<li>Lancer le projet avec IntelliJ.</li>
<li>Dans la classe <em>DiscoveryServiceApplication</em>, ajouter l'annotation <em>EnableEurekaServer</em>.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.discoveryservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="nd">@EnableEurekaServer</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DiscoveryServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">DiscoveryServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<ul>
<li>Ajouter les propriétés suivantes dans son fichier <em>application.properties</em>.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">spring.application.name</span><span class="o">=</span><span class="s">discovery-service</span>
<span class="na">spring.cloud.config.uri</span><span class="o">=</span><span class="s">http://localhost:8888</span>
</pre></div>

<ul>
<li>Dans le projet <em>config-service</em>, créer un fichier <em>discovery-service.properties</em> sous le répertoire <em>myConfig</em>.</li>
<li>Ajouter les propriétés suivantes pour (1) définir le port par défaut du service de découverte et (2) empêcher un auto-enregistrement du service Eureka.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">server.port</span> <span class="o">=</span> <span class="s">8761</span>
<span class="na">eureka.client.fetch-registry</span> <span class="o">=</span> <span class="s">false</span>
<span class="na">eureka.client.register-with-eureka</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>

<p>Pour consulter le service Eureka, aller à <a href="http://localhost:8761">http://localhost:8761</a>, l'interface suivante s'affiche:</p>
<p><img alt="Console Eureka" src="../img/tp4/eureka-console.png" /></p>
<p>Nous remarquons qu'aucune instance n'est inscrite dans le serveur de découverte. Nous allons donc modifier le code de la classe <em>ProductServiceApplication</em> pour que le microservice <em>ProductService</em> s'enregistre:</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tpmicro.productservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>

<span class="hll"><span class="nd">@EnableDiscoveryClient</span>
</span><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ProductServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>Redémarrer les trois instances de services <em>ProductService</em> et actualiser la fenêtre de <em>Eureka</em>, vous verrez qu'un seul service est déclaré, avec trois adresses différentes.</p>
<p><img alt="Services sur Eureka" src="../img/tp4/eureka-services.png" /></p>
<h3 id="microservice-proxyservice">Microservice <strong>ProxyService</strong><a class="headerlink" href="#microservice-proxyservice" title="Permanent link">&para;</a></h3>
<p>L'architecture microservice, en fournissant un ensemble de services indépendants et faiblement couplés, se trouve confrontée au challenge de fournir une interface unifiée pour les consommateurs, de manière à ce qu'ils ne voient pas la décomposition à faible granularité de vos services. C'est pour cela que l'utilisation d'un service proxy, responsable du routage des requêtes et de la répartition de charge, est important.</p>
<p><center><img src="../img/tp4/archi-s5.png"></center></p>
<p>Netflix offre le service <a href="https://github.com/Netflix/zuul">Zuul</a> pour réaliser cela. Pour créer votre microservice Proxy:</p>
<ul>
<li>Aller à <em>Spring Initializr</em>.</li>
<li>Créer le projet <em>proxy-service</em> avec les dépendances suivantes: Zuul, Web, HATEOAS, Actuator, Config Client et Eureka Discovery.</li>
<li>Ouvrir le service avec IntelliJ IDEA.</li>
<li>Ajouter à la classe <em>ProxyServiceApplication</em> l'annotation <em>@EnableZuulProxy</em>, ainsi que <em>@EnableDiscoveryClient</em> pour que le proxy soit également enregistré dans le service ce découverte.</li>
<li>Ajouter les propriétés <em>spring.application.name</em>  et <em>spring.cloud.config.uri</em> dans le fichier <em>application.properties</em> du service proxy.</li>
<li>Créer le fichier <em>proxy-service.properties</em> dans le répertoire <em>myConfig</em> du service de configuration, dans lequel vous allez fixer le port du service proxy à 9999.</li>
</ul>
<p>En lançant le service Proxy, vous remarquerez qu'il est rajouté dans Eureka.</p>
<p><img alt="Service Proxy dans Eureka" src="../img/tp4/proxy-eureka.png" /></p>
<p>Si vous exécutez la requête <a href="http://localhost:9999/product-service/messages">http://localhost:9999/product-service/messages</a> plusieurs fois, vous remarquerez que l'affichage <em>c'est moi qui ait répondu!</em> s'affichera sur les consoles des trois instances respectivement, à tour de rôle.</p>
<h2 id="homework">Homework<a class="headerlink" href="#homework" title="Permanent link">&para;</a></h2>
<p>Le concept de microservices est très fortement lié à la culture DevOps, et à la conteneurisation. Grâce aux conteneurs, vous n’avez pas besoin de développer et de configurer entièrement un nouveau serveur physique, ni de mettre sur pied un nouvel environnement virtuel, ce qui requiert une émulation de processeur, un système d’exploitation et des logiciels installés. Le conteneur vous permet de faire tenir un environnement complet dans une seule image légère.</p>
<p>C'est pour cela que votre tâche pour la séance prochaine sera de <em>dockeriser</em> les différents microservices que nous venons de créer, au lieu de les lancer sur notre machine physique (localhost). Les trois instances du service ProductService, ainsi que les trois autres services (Discovery, Config et Proxy) doivent tourner indépendamment, chacun dans soon propre contenaire.</p>
<p>Vous devez fournir chacun un lien vers un projet <strong>Github</strong> contenant vos projets, ainsi qu'un <strong>Readme</strong> en bonne et due forme (respecter la norme Markdown svp) montrant les étapes de conteneurisation des services. Chaque binôme devra fournir son lien dans le fichier excel intitulé <em>Homework</em> que vous trouverez dans <a href="https://piazza.com/class/j3k0yr6cyex4n8">Piazza</a>.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../tp3/" title="TP3" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                TP3
              </span>
            </div>
          </a>
        
        
          <a href="../tp5/" title="TP5" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                TP5
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 - 2018 Lilia Sfaxi
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="http://liliasfaxi.wix.com/liliasfaxi" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/liliasfaxi" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/lillitou" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/liliasfaxi/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/raphael-min.js"></script>
      <script src="../assets/javascripts/flowchart.js"></script>
      <script src="../assets/javascripts/application-e3caa82af6.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
        <script src="../search/require.js"></script>
      
        <script src="../search/search.js"></script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","None","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>